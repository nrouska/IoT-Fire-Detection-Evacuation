<div>
    <h1><b>Devices Manager</b></h1>
</div>

<div style="padding: 15px; border-radius: 8px; display: flex; gap: 10px; align-items: center;">
    <label><b>Add New:</b></label>
    <select id="deviceTypeSelect" style="padding: 5px;">
        <option value="Camera">Camera</option>
    </select>
    
    <button id="addDeviceBtn" style="cursor: pointer;">
        <span class="material-symbols-outlined" style="vertical-align: middle;">add</span> Create
    </button>
</div>

<hr>

<table>
    <tr>
        <th>Name</th>
        <th>Type</th>
        {{!-- <th>Connection Info</th> --}}
        <th>Status</th>
        <th>Map</th>
    </tr>

    {{#each devices}}
    <tr>
        <td><b>{{this.name}}</b></td>
        <td><span style="background: rgba(41,61,237,0.6); padding: 2px 6px; border-radius: 4px; font-size: 0.8em;">{{this.type}}</span></td>
        {{!-- <td style="font-size: 0.8em; color: #555;">{{this.info}}</td> --}}
        <td>{{this.status}}</td>
        <td style="display: flex;">
            {{#if (isCamera this.type)}}
                <a href="/cameraview/{{this.id}}" style="text-decoration: none;"
                   onclick="window.open(this.href, 'popup', 'width=600,height=400'); return false;">
                    <button class="me-2" style="padding: .25rem">
                        <span class="material-symbols-outlined">visibility</span>
                    </button>
                </a>
            {{/if}}
            <a href="/device/{{this.id}}/topology">
                <button style="cursor: pointer; padding: 5px;">Edit Location</button>
            </a>
        </td>
    </tr>
    {{else}}
    <tr><td colspan="5" style="text-align: center; color: gray; padding: 20px;">No devices found.</td></tr>
    {{/each}}
</table>

<div id="deviceModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    
    <div style="background: white; padding: 25px; border-radius: 8px; width: 400px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
        <h2 style="margin-top: 0;">Add New <span id="modalTypeLabel">Device</span></h2>
        
        <div id="modalError" style="display: none; background: #ffebee; color: #c62828; padding: 10px; border-radius: 4px; font-size: 0.9em; margin-bottom: 15px;"></div>

        <div style="display: flex; flex-direction: column; gap: 15px;">
            
            <div>
                <label style="display: block; font-weight: bold; margin-bottom: 5px;">Device Name</label>
                <input type="text" id="devName" placeholder="e.g., Camera 1" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;">
            </div>

            <div>
                <label id="devInfoLabel" style="display: block; font-weight: bold; margin-bottom: 5px;">Connection Info</label>
                <input type="text" id="devInfo" placeholder="e.g., http://..." style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;">
            </div>

            <div style="display: flex; gap: 10px; margin-top: 10px; justify-content: flex-end;">
                <button id="cancelBtn" style="padding: 10px 15px; background: #eee; border: none; border-radius: 4px; cursor: pointer;">Cancel</button>
                <button id="confirmAddBtn" style="padding: 10px 20px; background: #2ecc71; color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer;">Save & Configure</button>
            </div>
        </div>
    </div>
</div>

<script>
    const modal = document.getElementById('deviceModal');
    const openBtn = document.getElementById('addDeviceBtn'); 
    const cancelBtn = document.getElementById('cancelBtn');
    const confirmBtn = document.getElementById('confirmAddBtn');
    const typeSelect = document.getElementById('deviceTypeSelect');
    
    const nameInput = document.getElementById('devName');
    const infoInput = document.getElementById('devInfo');
    const infoLabel = document.getElementById('devInfoLabel');
    const typeLabel = document.getElementById('modalTypeLabel');
    const errorBox = document.getElementById('modalError');

    openBtn.addEventListener('click', () => {
        const type = typeSelect.value;
        
        // Update Labels based on selection
        typeLabel.innerText = type;
        nameInput.value = ''; // Clear previous
        infoInput.value = ''; 
        errorBox.style.display = 'none'; // Hide error

        if (type === "Camera") {
            infoLabel.innerText = "Stream URL / IP";
            infoInput.placeholder = "http://192.168.1.50";
        } else if (type === "AccessPoint") {
            infoLabel.innerText = "Router IP Address";
            infoInput.placeholder = "192.168.1.1";
        } else {
            infoLabel.innerText = "Sensor ID / MQTT Topic";
            infoInput.placeholder = "sensor_01";
        }

        modal.style.display = 'flex'; // Show modal
        nameInput.focus();
    });

    cancelBtn.addEventListener('click', () => {
        modal.style.display = 'none';
    });

    modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.style.display = 'none';
    });

    confirmBtn.addEventListener('click', async () => {
        const type = typeSelect.value;
        const name = nameInput.value.trim();
        const info = infoInput.value.trim();

        if (!name) {
            showError("Please enter a device name.");
            return;
        }

        try {
            const res = await fetch('/api/devices', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: name, name: name, type: type, info: info })
            });

            const data = await res.json(); 

            if (res.ok) {
                // Now 'data' exists, so we can get the real ID
                const realId = data.device ? data.device.id : data.id;
                
                // Redirect to the FULL ID (urn:ngsi-ld:Camera:...)
                window.location.href = `/device/${realId}/topology`;
            } else {
                const data = await res.json();
                showError(data.error || "Unknown Error");
            }
        } catch (err) {
            console.error(err);
            showError("Network Error");
        }
    });

    function showError(msg) {
        errorBox.innerText =  msg;
        errorBox.style.display = 'block';
    }
</script>